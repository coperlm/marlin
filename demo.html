<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marlin zkSNARK 代码演示 - 真实Rust实现</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="rust-marlin-client.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .code-block {
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
        }
        .terminal {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }
        .loading-bar {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
            background-size: 200% 200%;
            animation: gradient 2s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Marlin zkSNARK 代码演示</h1>
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mt-4">
                        <div class="flex">
                            <i class="fas fa-microchip mr-2 mt-1"></i>
                            <div>
                                <strong>🦀 真正的Rust底层调用！</strong>
                                <p class="text-sm">直接调用本地Rust可执行文件，真实的密码学计算</p>
                                <p class="text-xs mt-1 opacity-75">需要启动本地服务器: npm start</p>
                            </div>
                        </div>
                    </div>
                    <p class="opacity-90">实时模拟和代码展示</p>
                </div>
                <a href="visualization.html" class="bg-white/20 px-4 py-2 rounded-lg backdrop-blur-sm hover:bg-white/30 transition">
                    <i class="fas fa-chart-bar mr-2"></i>可视化展示
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8" x-data="marlinCodeDemo()">
        
        <!-- Advanced Control Panel -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">高级模拟控制台</h2>
                
                <!-- Circuit Selection -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">选择电路类型</h3>
                    <div class="grid md:grid-cols-4 gap-4">
                        <button @click="selectCircuitType('simple')" 
                                :class="circuitType === 'simple' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium hover:bg-blue-500 hover:text-white transition">
                            <i class="fas fa-calculator mr-2"></i>简单运算
                        </button>
                        <button @click="selectCircuitType('complex')" 
                                :class="circuitType === 'complex' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium hover:bg-blue-500 hover:text-white transition">
                            <i class="fas fa-cogs mr-2"></i>复杂电路
                        </button>
                        <button @click="selectCircuitType('hash')" 
                                :class="circuitType === 'hash' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium hover:bg-blue-500 hover:text-white transition">
                            <i class="fas fa-hashtag mr-2"></i>哈希函数
                        </button>
                        <button @click="selectCircuitType('custom')" 
                                :class="circuitType === 'custom' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium hover:bg-blue-500 hover:text-white transition">
                            <i class="fas fa-tools mr-2"></i>自定义
                        </button>
                    </div>
                </div>

                <!-- Circuit Parameters -->
                <div class="grid lg:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">电路参数</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">约束数量</label>
                                    <input type="number" x-model="constraints" min="10" max="100000" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">变量数量</label>
                                    <input type="number" x-model="variables" min="5" max="50000"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <!-- Circuit-specific parameters -->
                            <div x-show="circuitType === 'simple'">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">私密值 A</label>
                                        <input type="number" x-model="witnessA" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">私密值 B</label>
                                        <input type="number" x-model="witnessB" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600 mt-2">
                                    公开输出: <span class="font-mono font-bold" x-text="witnessA * witnessB"></span>
                                </div>
                            </div>

                            <div x-show="circuitType === 'hash'">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">预映像 (Preimage)</label>
                                    <input type="text" x-model="hashPreimage" placeholder="输入要哈希的字符串" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="text-sm text-gray-600 mt-2">
                                    模拟 SHA256 哈希: <span class="font-mono text-xs" x-text="hashPreimage ? 'sha256(' + hashPreimage + ')' : 'N/A'"></span>
                                </div>
                            </div>

                            <div x-show="circuitType === 'custom'">
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">选择电路模板</label>
                                        <select @change="loadCircuitTemplate($event.target.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <option value="">选择模板...</option>
                                            <option value="polynomial">多项式验证 (x³ + 2x² + x = result)</option>
                                            <option value="comparison">数值比较 (证明 a > b)</option>
                                            <option value="range">范围证明 (min ≤ value ≤ max)</option>
                                            <option value="sudoku">数独验证 (9x9)</option>
                                        </select>
                                    </div>
                                    
                                    <div x-show="customCircuit" class="bg-gray-50 rounded-lg p-3">
                                        <h5 class="font-semibold text-gray-700 mb-2" x-text="customCircuit?.name"></h5>
                                        <div class="text-sm text-gray-600 space-y-1">
                                            <div>约束数量: <span class="font-mono" x-text="customCircuit?.constraints || 0"></span></div>
                                            <div>变量数量: <span class="font-mono" x-text="customCircuit?.variables || 0"></span></div>
                                            <div>公开输入: <span class="font-mono" x-text="customCircuit?.publicInputs || 0"></span></div>
                                            <div>私密见证: <span class="font-mono" x-text="customCircuit?.privateWitness || 0"></span></div>
                                        </div>
                                        <div class="mt-2 text-xs text-blue-600">
                                            <span x-text="customCircuit?.description"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">性能预估</h3>
                        <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Setup 时间:</span>
                                <span class="font-mono" x-text="getPerformanceEstimate().setupTime + ' ms'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">证明时间:</span>
                                <span class="font-mono" x-text="getPerformanceEstimate().proveTime + ' ms'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">验证时间:</span>
                                <span class="font-mono" x-text="getPerformanceEstimate().verifyTime + ' ms'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">证明大小:</span>
                                <span class="font-mono" x-text="getPerformanceEstimate().proofSize + ' bytes'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">内存使用:</span>
                                <span class="font-mono" x-text="getPerformanceEstimate().memory + ' MB'"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="flex space-x-4">
                    <button @click="runFullDemo()" :disabled="isRunning"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                        <span x-show="!isRunning">
                            <i class="fas fa-play mr-2"></i>运行完整演示
                        </span>
                        <span x-show="isRunning" class="flex items-center justify-center">
                            <i class="fas fa-spinner fa-spin mr-2"></i>运行中...
                        </span>
                    </button>
                    <button @click="runSingleStep()" :disabled="isRunning"
                            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 font-medium">
                        <i class="fas fa-step-forward mr-2"></i>单步执行
                    </button>
                    <button @click="resetDemo()" :disabled="isRunning"
                            class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 font-medium">
                        <i class="fas fa-redo mr-2"></i>重置
                    </button>
                </div>
            </div>
        </section>

        <!-- Demo Steps -->
        <div class="space-y-8">
            
            <!-- Step 1: Universal Setup -->
            <section class="bg-white rounded-lg shadow-lg overflow-hidden" :class="{'slide-in': currentStep >= 1}">
                <div class="bg-blue-600 text-white px-6 py-4">
                    <h3 class="text-xl font-bold flex items-center">
                        <i class="fas fa-cogs mr-3"></i>
                        步骤 1: 通用设置 (Universal Setup)
                        <span x-show="currentStep >= 1" class="ml-auto">
                            <i class="fas fa-check-circle text-green-300"></i>
                        </span>
                    </h3>
                </div>
                <div class="p-6">
                    <div class="grid lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">Rust 代码示例</h4>
                            <div class="code-block">
                                <pre><code class="language-rust">use ark_marlin::Marlin;
use ark_bls12_381::{Bls12_381, Fr};
use ark_poly_commit::marlin_pc::MarlinKZG10;

type MarlinInst = Marlin&lt;Fr, MarlinKZG10&lt;Bls12_381, DensePolynomial&lt;Fr&gt;&gt;, Blake2s&gt;;

// 通用设置
let rng = &mut ark_std::test_rng();
let universal_srs = MarlinInst::universal_setup(
    constraints,  // 约束数量
    variables,    // 变量数量 
    non_zero,     // 非零元素数量
    rng
)?;</code></pre>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">执行结果</h4>
                            <div x-show="universalSRS" class="terminal p-4 rounded-lg text-sm">
                                <div class="text-yellow-400">✓ Universal SRS 生成完成</div>
                                <div class="mt-2">
                                    <span class="text-cyan-400">max_degree:</span> 
                                    <span x-text="universalSRS?.maxDegree"></span>
                                </div>
                                <div>
                                    <span class="text-cyan-400">parameters:</span> 
                                    <span class="font-mono text-xs" x-text="universalSRS?.parameters?.substring(0, 20) + '...'"></span>
                                </div>
                                <div>
                                    <span class="text-cyan-400">timestamp:</span> 
                                    <span x-text="universalSRS?.timestamp"></span>
                                </div>
                            </div>
                            <div x-show="currentStep >= 1 && !universalSRS" class="flex items-center justify-center py-8">
                                <div class="loading-bar h-2 w-full rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 2: Index Generation -->
            <section class="bg-white rounded-lg shadow-lg overflow-hidden" :class="{'slide-in': currentStep >= 2}" x-show="currentStep >= 2">
                <div class="bg-purple-600 text-white px-6 py-4">
                    <h3 class="text-xl font-bold flex items-center">
                        <i class="fas fa-database mr-3"></i>
                        步骤 2: 电路索引 (Circuit Indexing)
                        <span x-show="currentStep >= 2" class="ml-auto">
                            <i class="fas fa-check-circle text-green-300"></i>
                        </span>
                    </h3>
                </div>
                <div class="p-6">
                    <div class="grid lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">Rust 代码示例</h4>
                            <div class="code-block">
                                <pre><code class="language-rust">// 定义约束系统
#[derive(Clone)]
struct ExampleCircuit&lt;F: Field&gt; {
    pub a: Option&lt;F&gt;,
    pub b: Option&lt;F&gt;,
}

impl&lt;F: Field&gt; ConstraintSynthesizer&lt;F&gt; for ExampleCircuit&lt;F&gt; {
    fn generate_constraints(
        self,
        cs: ConstraintSystemRef&lt;F&gt;,
    ) -> Result&lt;(), SynthesisError&gt; {
        let a = cs.new_witness_variable(|| self.a.ok_or(SynthesisError::AssignmentMissing))?;
        let b = cs.new_witness_variable(|| self.b.ok_or(SynthesisError::AssignmentMissing))?;
        let c = cs.new_input_variable(|| {
            let a = self.a.ok_or(SynthesisError::AssignmentMissing)?;
            let b = self.b.ok_or(SynthesisError::AssignmentMissing)?;
            Ok(a * b)
        })?;
        
        cs.enforce_constraint(lc!() + a, lc!() + b, lc!() + c)?;
        Ok(())
    }
}

// 生成索引
let circuit = ExampleCircuit { a: None, b: None };
let (index_pk, index_vk) = MarlinInst::index(&universal_srs, circuit)?;</code></pre>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">索引信息</h4>
                            <div x-show="indexKeys" class="terminal p-4 rounded-lg text-sm">
                                <div class="text-yellow-400">✓ 索引密钥生成完成</div>
                                <div class="mt-2">
                                    <span class="text-cyan-400">约束数量:</span> 
                                    <span x-text="indexKeys?.verifierKey?.indexInfo?.numConstraints"></span>
                                </div>
                                <div>
                                    <span class="text-cyan-400">变量数量:</span> 
                                    <span x-text="indexKeys?.verifierKey?.indexInfo?.numVariables"></span>
                                </div>
                                <div>
                                    <span class="text-cyan-400">非零元素:</span> 
                                    <span x-text="indexKeys?.verifierKey?.indexInfo?.numNonZero"></span>
                                </div>
                                <div class="mt-2 text-green-400">
                                    <div>• IndexProverKey 生成</div>
                                    <div>• IndexVerifierKey 生成</div>
                                    <div>• 索引多项式承诺完成</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 3: Proof Generation -->
            <section class="bg-white rounded-lg shadow-lg overflow-hidden" :class="{'slide-in': currentStep >= 3}" x-show="currentStep >= 3">
                <div class="bg-green-600 text-white px-6 py-4">
                    <h3 class="text-xl font-bold flex items-center">
                        <i class="fas fa-key mr-3"></i>
                        步骤 3: 证明生成 (Proof Generation)
                        <span x-show="proof" class="ml-auto">
                            <i class="fas fa-check-circle text-green-300"></i>
                        </span>
                    </h3>
                </div>
                <div class="p-6">
                    <div class="grid lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">Rust 代码示例</h4>
                            <div class="code-block">
                                <pre><code class="language-rust">// 创建具体的约束实例
let a = Fr::from(3u64);
let b = Fr::from(5u64);
let c = a * b;  // c = 15

let circuit = ExampleCircuit {
    a: Some(a),
    b: Some(b),
};

// 生成证明
let rng = &mut ark_std::test_rng();
let proof = MarlinInst::prove(&index_pk, circuit, rng)?;

// 证明包含：
// - 多项式承诺 (commitments)
// - 求值结果 (evaluations) 
// - 证明者消息 (prover_messages)
// - PC 证明 (pc_proof)</code></pre>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">证明结构</h4>
                            <div x-show="proof" class="terminal p-4 rounded-lg text-sm max-h-96 overflow-y-auto">
                                <div class="text-yellow-400">✓ zkSNARK 证明生成完成</div>
                                <div class="mt-2">
                                    <div class="text-cyan-400">承诺轮次:</div>
                                    <template x-for="(round, index) in proof?.commitments || []" :key="index">
                                        <div class="ml-4 text-gray-300">
                                            <span>Round </span><span x-text="index + 1"></span>: 
                                            <span x-text="round.length"></span> 个承诺
                                        </div>
                                    </template>
                                </div>
                                <div class="mt-2">
                                    <span class="text-cyan-400">求值数量:</span> 
                                    <span x-text="proof?.evaluations?.length"></span>
                                </div>
                                <div>
                                    <span class="text-cyan-400">证明大小:</span> 
                                    <span x-text="proof?.size"></span> bytes
                                </div>
                                <div class="mt-2 text-green-400">
                                    <div>• 第一轮: w, z_a, z_b, mask_poly 承诺</div>
                                    <div>• 第二轮: t, g_1, h_1 承诺</div>
                                    <div>• 第三轮: g_2, h_2 承诺</div>
                                    <div>• Fiat-Shamir 变换完成</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 4: Verification -->
            <section class="bg-white rounded-lg shadow-lg overflow-hidden" :class="{'slide-in': currentStep >= 4}" x-show="currentStep >= 4">
                <div class="bg-cyan-600 text-white px-6 py-4">
                    <h3 class="text-xl font-bold flex items-center">
                        <i class="fas fa-check-circle mr-3"></i>
                        步骤 4: 证明验证 (Proof Verification)
                        <span x-show="verificationResult" class="ml-auto">
                            <i class="fas fa-check-circle text-green-300"></i>
                        </span>
                    </h3>
                </div>
                <div class="p-6">
                    <div class="grid lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">Rust 代码示例</h4>
                            <div class="code-block">
                                <pre><code class="language-rust">// 验证证明
let public_input = vec![c];  // 公开输入: c = 15
let rng = &mut ark_std::test_rng();

let is_valid = MarlinInst::verify(
    &index_vk,
    &public_input,
    &proof,
    rng
)?;

println!("Proof verification: {}", is_valid);

// 验证过程包括：
// 1. 重建 Fiat-Shamir 挑战
// 2. 检查线性组合
// 3. 验证多项式承诺
// 4. 确认 sumcheck 协议</code></pre>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-3">验证结果</h4>
                            <div x-show="verificationResult" class="terminal p-4 rounded-lg text-sm">
                                <div :class="verificationResult?.isValid ? 'text-green-400' : 'text-red-400'">
                                    <span x-text="verificationResult?.isValid ? '✓ 证明验证成功' : '✗ 证明验证失败'"></span>
                                </div>
                                <div class="mt-2" x-show="verificationResult?.isValid">
                                    <span class="text-cyan-400">验证时间:</span> 
                                    <span x-text="verificationResult?.verificationTime"></span> ms
                                </div>
                                <div class="mt-2 text-gray-300">
                                    <div class="text-cyan-400">执行的检查:</div>
                                    <template x-for="check in verificationResult?.checksPerformed || []" :key="check">
                                        <div class="ml-4 text-green-400">
                                            ✓ <span x-text="check"></span>
                                        </div>
                                    </template>
                                </div>
                                <div class="mt-3 p-3 bg-green-900/30 rounded border border-green-600">
                                    <div class="text-green-400 font-semibold">🎉 零知识证明完成！</div>
                                    <div class="text-sm text-gray-300 mt-1">
                                        证明者成功证明了知道满足约束 a × b = c 的私密值 a 和 b，
                                        而验证者无需了解 a 和 b 的具体值。
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <!-- Performance Analysis -->
        <section class="mt-12 bg-white rounded-lg shadow-lg p-6" x-show="verificationResult">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">性能分析</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">O(n)</div>
                    <div class="text-sm text-gray-600">证明生成时间</div>
                    <div class="text-xs text-gray-500 mt-1">线性于约束数量</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">O(log n)</div>
                    <div class="text-sm text-gray-600">验证时间</div>
                    <div class="text-xs text-gray-500 mt-1">对数级验证复杂度</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" x-text="proof?.size || 0"></div>
                    <div class="text-sm text-gray-600">证明大小 (bytes)</div>
                    <div class="text-xs text-gray-500 mt-1">紧凑的证明尺寸</div>
                </div>
                <div class="text-center p-4 bg-cyan-50 rounded-lg">
                    <div class="text-2xl font-bold text-cyan-600">128-bit</div>
                    <div class="text-sm text-gray-600">安全级别</div>
                    <div class="text-xs text-gray-500 mt-1">密码学安全保证</div>
                </div>
            </div>
        </section>

    </main>

    <script>
        function marlinCodeDemo() {
            return {
                constraints: 100,
                variables: 50,
                currentStep: 0,
                isRunning: false,
                simulator: new MarlinSimulator(),
                universalSRS: null,
                indexKeys: null,
                proof: null,
                verificationResult: null,
                
                // Circuit Type and Parameters
                circuitType: 'simple',
                witnessA: 3,
                witnessB: 5,
                hashPreimage: 'hello world',
                singleStepMode: false,
                customCircuit: null,

                async runFullDemo() {
                    if (this.isRunning) return;
                    
                    this.isRunning = true;
                    this.currentStep = 0;
                    this.simulator.reset();
                    
                    try {
                        // Step 1: Universal Setup
                        this.currentStep = 1;
                        this.simulator.currentConstraints = parseInt(this.constraints);
                        this.simulator.currentVariables = parseInt(this.variables);
                        
                        this.universalSRS = await this.simulator.simulateUniversalSetup(
                            this.constraints, 
                            this.variables, 
                            Math.floor(this.constraints * 0.7)
                        );
                        
                        await this.delay(1000);
                        
                        // Step 2: Index Generation
                        this.currentStep = 2;
                        this.indexKeys = await this.simulator.simulateIndexGeneration(
                            "Example Circuit: a × b = c"
                        );
                        
                        await this.delay(1000);
                        
                        // Step 3: Proof Generation
                        this.currentStep = 3;
                        this.proof = await this.simulator.simulateProofGeneration(
                            { a: 3, b: 5 },
                            { c: 15 }
                        );
                        
                        await this.delay(1000);
                        
                        // Step 4: Verification
                        this.currentStep = 4;
                        this.verificationResult = await this.simulator.simulateVerification(
                            this.proof,
                            { c: 15 }
                        );
                        
                    } catch (error) {
                        console.error('Demo error:', error);
                    } finally {
                        this.isRunning = false;
                    }
                },

                delay(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                },

                // Circuit Type Selection
                selectCircuitType(type) {
                    this.circuitType = type;
                    this.updateConstraintsForCircuit();
                },

                updateConstraintsForCircuit() {
                    switch (this.circuitType) {
                        case 'simple':
                            this.constraints = 5;
                            this.variables = 4;
                            break;
                        case 'complex':
                            this.constraints = 1000;
                            this.variables = 500;
                            break;
                        case 'hash':
                            this.constraints = 30000;
                            this.variables = 15000;
                            break;
                        case 'custom':
                            if (this.customCircuit) {
                                this.constraints = this.customCircuit.constraints;
                                this.variables = this.customCircuit.variables;
                            } else {
                                // Keep user-defined values
                            }
                            break;
                    }
                },

                getPerformanceEstimate() {
                    const c = parseInt(this.constraints);
                    const v = parseInt(this.variables);
                    
                    return {
                        setupTime: Math.floor(c / 10 + v / 20),
                        proveTime: Math.floor(c / 5 + v / 10),
                        verifyTime: Math.floor(Math.log2(c) * 5 + 10),
                        proofSize: Math.floor(1024 + Math.sqrt(c) * 32),
                        memory: Math.floor((c + v) / 1000 + 10)
                    };
                },

                async runSingleStep() {
                    if (this.isRunning) return;
                    
                    this.singleStepMode = true;
                    
                    if (this.currentStep === 0) {
                        await this.runSetupStep();
                    } else if (this.currentStep === 1) {
                        await this.runIndexStep();
                    } else if (this.currentStep === 2) {
                        await this.runProvingStep();
                    } else if (this.currentStep === 3) {
                        await this.runVerificationStep();
                    }
                    
                    this.singleStepMode = false;
                },

                async runSetupStep() {
                    this.isRunning = true;
                    this.currentStep = 1;
                    this.simulator.currentConstraints = parseInt(this.constraints);
                    this.simulator.currentVariables = parseInt(this.variables);
                    
                    this.universalSRS = await this.simulator.simulateUniversalSetup(
                        this.constraints, 
                        this.variables, 
                        Math.floor(this.constraints * 0.7)
                    );
                    this.isRunning = false;
                },

                async runIndexStep() {
                    this.isRunning = true;
                    this.currentStep = 2;
                    
                    const circuitDesc = this.getCircuitDescription();
                    this.indexKeys = await this.simulator.simulateIndexGeneration(circuitDesc);
                    this.isRunning = false;
                },

                async runProvingStep() {
                    this.isRunning = true;
                    this.currentStep = 3;
                    
                    const witness = this.getWitnessData();
                    const publicInput = this.getPublicInput();
                    
                    this.proof = await this.simulator.simulateProofGeneration(witness, publicInput);
                    this.isRunning = false;
                },

                async runVerificationStep() {
                    this.isRunning = true;
                    this.currentStep = 4;
                    
                    const publicInput = this.getPublicInput();
                    this.verificationResult = await this.simulator.simulateVerification(
                        this.proof, 
                        publicInput, 
                        this.circuitType,
                        this.customCircuit
                    );
                    this.isRunning = false;
                },

                getCircuitDescription() {
                    switch (this.circuitType) {
                        case 'simple':
                            return `Simple Multiplication Circuit: ${this.witnessA} × ${this.witnessB} = ${this.witnessA * this.witnessB}`;
                        case 'complex':
                            return "Complex Multi-Constraint Circuit";
                        case 'hash':
                            return `SHA256 Preimage Circuit: SHA256("${this.hashPreimage}")`;
                        case 'custom':
                            if (this.customCircuit && this.customCircuit.name) {
                                return `Custom Circuit: ${this.customCircuit.name} (${this.customCircuit.constraints.length} constraints, ${this.customCircuit.variables.length} variables)`;
                            }
                            return `Custom Circuit: ${this.constraints} constraints, ${this.variables} variables`;
                        default:
                            return "Unknown Circuit";
                    }
                },

                getWitnessData() {
                    switch (this.circuitType) {
                        case 'simple':
                            return { a: this.witnessA, b: this.witnessB };
                        case 'hash':
                            return { preimage: this.hashPreimage };
                        default:
                            return { data: "mock_witness_data" };
                    }
                },

                getPublicInput() {
                    switch (this.circuitType) {
                        case 'simple':
                            return { c: this.witnessA * this.witnessB };
                        case 'hash':
                            return { hash: "mock_sha256_hash" };
                        default:
                            return { output: "mock_public_output" };
                    }
                },

                resetDemo() {
                    this.currentStep = 0;
                    this.universalSRS = null;
                    this.indexKeys = null;
                    this.proof = null;
                    this.verificationResult = null;
                    this.simulator.reset();
                },

                loadCircuitTemplate(templateType) {
                    switch (templateType) {
                        case 'polynomial':
                            this.customCircuit = {
                                name: '多项式验证电路',
                                constraints: 4,
                                variables: 5,
                                publicInputs: 2,
                                privateWitness: 3,
                                description: '证明知道 x 使得 x³ + 2x² + x = result，其中 result 是公开的'
                            };
                            break;
                        case 'comparison':
                            this.customCircuit = {
                                name: '数值比较电路',
                                constraints: 8,
                                variables: 6,
                                publicInputs: 1,
                                privateWitness: 5,
                                description: '在不透露具体数值的情况下证明 a > b'
                            };
                            break;
                        case 'range':
                            this.customCircuit = {
                                name: '范围证明电路',
                                constraints: 16,
                                variables: 10,
                                publicInputs: 2,
                                privateWitness: 8,
                                description: '证明私密值在指定范围内，而不透露具体值'
                            };
                            break;
                        case 'sudoku':
                            this.customCircuit = {
                                name: '数独验证电路',
                                constraints: 2430,  // 9x9 grid with validation
                                variables: 162,     // 81 cells + auxiliary variables
                                publicInputs: 30,   // Known cells
                                privateWitness: 132,
                                description: '验证9x9数独解的正确性，已知部分格子的值'
                            };
                            break;
                        default:
                            this.customCircuit = null;
                    }
                    this.updateConstraintsForCircuit();
                }
            }
        }
    </script>
</body>
</html>