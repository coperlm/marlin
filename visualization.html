<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marlin zkSNARK 可视化展示 - 真实Rust实现</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="rust-marlin-client.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .protocol-flow {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .typing-animation {
            overflow: hidden;
            border-right: 2px solid #3b82f6;
            white-space: nowrap;
            animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
        }
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: #3b82f6; }
        }
        .flow-arrow {
            position: relative;
        }
        .flow-arrow::after {
            content: '';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid #3b82f6;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white py-16">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-5xl font-bold mb-4 typing-animation">Marlin zkSNARK</h1>
            <p class="text-xl opacity-90 mb-6">基于 Arkworks 的预处理零知识证明系统</p>
            <div class="bg-green-500/20 border border-green-300 text-green-100 px-6 py-3 rounded-lg mx-auto max-w-md mb-8">
                <div class="flex items-center justify-center">
                    <i class="fas fa-microchip mr-2"></i>
                    <strong>🦀 真正Rust底层调用</strong>
                </div>
                <p class="text-sm opacity-90 mt-1">直接执行本地Rust程序，真实的zkSNARK</p>
                <p class="text-xs opacity-75 mt-1">需要: npm start</p>
            </div>
            <div class="flex justify-center space-x-6 text-sm">
                <div class="bg-white/20 px-4 py-2 rounded-full backdrop-blur-sm">
                    <i class="fas fa-shield-alt mr-2"></i>零知识
                </div>
                <div class="bg-white/20 px-4 py-2 rounded-full backdrop-blur-sm">
                    <i class="fas fa-tachometer-alt mr-2"></i>高效验证
                </div>
                <div class="bg-white/20 px-4 py-2 rounded-full backdrop-blur-sm">
                    <i class="fas fa-code mr-2"></i>Rust 实现
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12" x-data="marlinDemo()">
        
        <!-- Protocol Overview -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">协议架构概览</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <!-- Universal Setup -->
                <div class="bg-white rounded-lg shadow-lg p-6 card-hover transition-all duration-300">
                    <div class="text-center mb-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                            <i class="fas fa-cogs text-blue-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">通用设置</h3>
                    </div>
                    <ul class="text-gray-600 space-y-2">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>生成 Universal SRS</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>多项式承诺方案</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>支持任意电路</li>
                    </ul>
                </div>

                <!-- Index Generation -->
                <div class="bg-white rounded-lg shadow-lg p-6 card-hover transition-all duration-300">
                    <div class="text-center mb-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-100 rounded-full mb-4">
                            <i class="fas fa-database text-purple-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">电路索引</h3>
                    </div>
                    <ul class="text-gray-600 space-y-2">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>R1CS 矩阵生成</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>索引多项式构造</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>验证密钥生成</li>
                    </ul>
                </div>

                <!-- Proof System -->
                <div class="bg-white rounded-lg shadow-lg p-6 card-hover transition-all duration-300">
                    <div class="text-center mb-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-cyan-100 rounded-full mb-4">
                            <i class="fas fa-certificate text-cyan-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">证明系统</h3>
                    </div>
                    <ul class="text-gray-600 space-y-2">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>AHP 协议</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Fiat-Shamir 变换</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>多轮交互优化</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Circuit Builder -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">电路构建器</h2>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Circuit Designer -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">
                            <i class="fas fa-tools text-blue-600 mr-2"></i>
                            设计你的电路
                        </h3>
                        <div class="space-y-4">
                            <!-- Circuit Type Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">电路类型</label>
                                <select x-model="selectedCircuit" @change="updateCircuitParams()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="multiplication">乘法电路 (a × b = c)</option>
                                    <option value="quadratic">二次方程 (a² + b² = c²)</option>
                                    <option value="hash">哈希预映像 (SHA256)</option>
                                    <option value="merkle">Merkle 树验证</option>
                                    <option value="custom">自定义电路</option>
                                </select>
                            </div>

                            <!-- Dynamic Parameters -->
                            <div x-show="selectedCircuit === 'multiplication'">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">私密值 A</label>
                                        <input type="number" x-model="circuitParams.a" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">私密值 B</label>
                                        <input type="number" x-model="circuitParams.b" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                </div>
                                <div class="mt-2 text-sm text-gray-600">
                                    公开输出: <span class="font-mono" x-text="circuitParams.a * circuitParams.b"></span>
                                </div>
                            </div>

                            <div x-show="selectedCircuit === 'quadratic'">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">边长 A</label>
                                        <input type="number" x-model="circuitParams.sideA" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">边长 B</label>
                                        <input type="number" x-model="circuitParams.sideB" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                </div>
                                <div class="mt-2 text-sm text-gray-600">
                                    斜边长: <span class="font-mono" x-text="Math.sqrt(circuitParams.sideA**2 + circuitParams.sideB**2).toFixed(2)"></span>
                                </div>
                            </div>

                            <div x-show="selectedCircuit === 'custom'">
                                <!-- Circuit Designer -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">电路名称</label>
                                        <input type="text" x-model="customCircuit.name" placeholder="例如：数独验证电路" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    
                                    <!-- Variables Section -->
                                    <div class="border rounded-lg p-4 bg-gray-50">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="font-semibold text-gray-800">变量定义</h4>
                                            <button @click="addVariable()" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                                <i class="fas fa-plus mr-1"></i>添加变量
                                            </button>
                                        </div>
                                        <div class="space-y-2 max-h-32 overflow-y-auto">
                                            <template x-for="(variable, index) in customCircuit.variables" :key="index">
                                                <div class="flex items-center space-x-2 bg-white p-2 rounded border">
                                                    <select x-model="variable.type" class="px-2 py-1 border rounded text-sm">
                                                        <option value="public">公开</option>
                                                        <option value="private">私密</option>
                                                        <option value="intermediate">中间</option>
                                                    </select>
                                                    <input type="text" x-model="variable.name" placeholder="变量名" 
                                                           class="flex-1 px-2 py-1 border rounded text-sm">
                                                    <input type="text" x-model="variable.description" placeholder="描述" 
                                                           class="flex-1 px-2 py-1 border rounded text-sm">
                                                    <button @click="removeVariable(index)" class="text-red-600 hover:text-red-800">
                                                        <i class="fas fa-trash text-xs"></i>
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Constraints Section -->
                                    <div class="border rounded-lg p-4 bg-gray-50">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="font-semibold text-gray-800">约束条件</h4>
                                            <button @click="addConstraint()" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                                                <i class="fas fa-plus mr-1"></i>添加约束
                                            </button>
                                        </div>
                                        <div class="space-y-2 max-h-40 overflow-y-auto">
                                            <template x-for="(constraint, index) in customCircuit.constraints" :key="index">
                                                <div class="bg-white p-3 rounded border">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="text-sm font-medium text-gray-700">约束 #<span x-text="index + 1"></span></span>
                                                        <button @click="removeConstraint(index)" class="text-red-600 hover:text-red-800">
                                                            <i class="fas fa-trash text-xs"></i>
                                                        </button>
                                                    </div>
                                                    <div class="grid grid-cols-3 gap-2 text-sm">
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">左操作数 (A)</label>
                                                            <input type="text" x-model="constraint.left" placeholder="例如：x1 + 2*x2" 
                                                                   class="w-full px-2 py-1 border rounded text-xs">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">右操作数 (B)</label>
                                                            <input type="text" x-model="constraint.right" placeholder="例如：x3" 
                                                                   class="w-full px-2 py-1 border rounded text-xs">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">输出 (C)</label>
                                                            <input type="text" x-model="constraint.output" placeholder="例如：x4" 
                                                                   class="w-full px-2 py-1 border rounded text-xs">
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 text-xs text-gray-600">
                                                        约束: (<span x-text="constraint.left || 'A'"></span>) × (<span x-text="constraint.right || 'B'"></span>) = <span x-text="constraint.output || 'C'"></span>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Circuit Templates -->
                                    <div class="border rounded-lg p-4 bg-blue-50">
                                        <h4 class="font-semibold text-gray-800 mb-3">快速模板</h4>
                                        <div class="grid grid-cols-2 gap-2">
                                            <button @click="loadTemplate('polynomial')" class="px-3 py-2 bg-white border rounded text-sm hover:bg-blue-50">
                                                <i class="fas fa-function mr-1"></i>多项式验证
                                            </button>
                                            <button @click="loadTemplate('comparison')" class="px-3 py-2 bg-white border rounded text-sm hover:bg-blue-50">
                                                <i class="fas fa-balance-scale mr-1"></i>数值比较
                                            </button>
                                            <button @click="loadTemplate('range')" class="px-3 py-2 bg-white border rounded text-sm hover:bg-blue-50">
                                                <i class="fas fa-arrows-alt-h mr-1"></i>范围证明
                                            </button>
                                            <button @click="loadTemplate('sudoku')" class="px-3 py-2 bg-white border rounded text-sm hover:bg-blue-50">
                                                <i class="fas fa-th mr-1"></i>数独验证
                                            </button>
                                        </div>
                                        
                                        <!-- Error Testing Templates -->
                                        <h5 class="font-semibold text-gray-800 mt-4 mb-2 text-sm">错误测试模板</h5>
                                        <div class="grid grid-cols-2 gap-2">
                                            <button @click="loadTemplate('error_contradiction')" class="px-3 py-2 bg-red-50 border border-red-200 rounded text-sm hover:bg-red-100 text-red-700">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>矛盾约束
                                            </button>
                                            <button @click="loadTemplate('error_zero_mult')" class="px-3 py-2 bg-red-50 border border-red-200 rounded text-sm hover:bg-red-100 text-red-700">
                                                <i class="fas fa-ban mr-1"></i>零乘法错误
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Circuit Stats -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">电路统计</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">约束数量:</span>
                                        <span class="font-mono" x-text="getCircuitStats().constraints"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">变量数量:</span>
                                        <span class="font-mono" x-text="getCircuitStats().variables"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">预估证明大小:</span>
                                        <span class="font-mono" x-text="getCircuitStats().proofSize + ' bytes'"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">验证时间:</span>
                                        <span class="font-mono" x-text="getCircuitStats().verifyTime + ' ms'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Circuit Visualization -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">
                            <i class="fas fa-eye text-purple-600 mr-2"></i>
                            电路可视化
                        </h3>
                        
                        <!-- Circuit Diagram for Custom Circuit -->
                        <div x-show="selectedCircuit === 'custom' && customCircuit.constraints.length > 0" class="mb-4 p-4 bg-white border rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">电路图</h4>
                            <div class="space-y-2">
                                <!-- Variables Display -->
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <template x-for="(variable, index) in customCircuit.variables" :key="index">
                                        <div class="px-2 py-1 rounded text-xs border"
                                             :class="variable.type === 'public' ? 'bg-green-100 border-green-300 text-green-800' : 
                                                    variable.type === 'private' ? 'bg-red-100 border-red-300 text-red-800' : 
                                                    'bg-yellow-100 border-yellow-300 text-yellow-800'">
                                            <span x-text="variable.name"></span>
                                            <span class="ml-1 opacity-75" x-text="'(' + variable.type + ')'"></span>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Constraints Flow -->
                                <div class="space-y-1">
                                    <template x-for="(constraint, index) in customCircuit.constraints.slice(0, 5)" :key="index">
                                        <div class="flex items-center text-xs bg-gray-50 p-2 rounded">
                                            <span class="w-4 h-4 bg-blue-500 rounded-full flex-shrink-0 mr-2 flex items-center justify-center text-white text-xs" x-text="index + 1"></span>
                                            <span class="flex-1">
                                                (<span x-text="constraint.left || 'A'"></span>) × (<span x-text="constraint.right || 'B'"></span>) = <span x-text="constraint.output || 'C'"></span>
                                            </span>
                                        </div>
                                    </template>
                                    <div x-show="customCircuit.constraints.length > 5" class="text-xs text-gray-500 pl-6">
                                        ... 还有 <span x-text="customCircuit.constraints.length - 5"></span> 个约束
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-900 rounded-lg p-6 text-green-400 font-mono text-sm h-96 overflow-y-auto">
                            <div x-show="selectedCircuit === 'multiplication'">
                                <div class="text-yellow-400 mb-2">// 乘法电路 R1CS 表示</div>
                                <div>witness = [1, a, b, c]</div>
                                <div>constraints:</div>
                                <div class="ml-4">
                                    <div>• a * b = c</div>
                                    <div>• 输入验证约束</div>
                                </div>
                                <div class="mt-4 text-blue-400">当前实例:</div>
                                <div class="ml-4">
                                    <div>a = <span x-text="circuitParams.a"></span> (私密)</div>
                                    <div>b = <span x-text="circuitParams.b"></span> (私密)</div>
                                    <div>c = <span x-text="circuitParams.a * circuitParams.b"></span> (公开)</div>
                                </div>
                                <div class="mt-4 text-cyan-400">矩阵表示:</div>
                                <div class="ml-4 text-xs">
                                    <div>A = [[0, 1, 0, 0]]</div>
                                    <div>B = [[0, 0, 1, 0]]</div>
                                    <div>C = [[0, 0, 0, 1]]</div>
                                </div>
                            </div>

                            <div x-show="selectedCircuit === 'quadratic'">
                                <div class="text-yellow-400 mb-2">// 勾股定理验证电路</div>
                                <div>witness = [1, a, b, c, a², b², c²]</div>
                                <div>constraints:</div>
                                <div class="ml-4">
                                    <div>• a * a = a²</div>
                                    <div>• b * b = b²</div>
                                    <div>• c * c = c²</div>
                                    <div>• a² + b² = c²</div>
                                </div>
                                <div class="mt-4 text-blue-400">当前实例:</div>
                                <div class="ml-4">
                                    <div>a = <span x-text="circuitParams.sideA"></span></div>
                                    <div>b = <span x-text="circuitParams.sideB"></span></div>
                                    <div>c = <span x-text="Math.sqrt(circuitParams.sideA**2 + circuitParams.sideB**2).toFixed(2)"></span></div>
                                </div>
                            </div>

                            <div x-show="selectedCircuit === 'hash'">
                                <div class="text-yellow-400 mb-2">// SHA256 预映像电路</div>
                                <div>约束数量: ~30,000</div>
                                <div>变量数量: ~15,000</div>
                                <div class="mt-2">证明知道 x 使得 SHA256(x) = hash</div>
                                <div class="mt-4 text-red-400">复杂度较高，适合大规模电路演示</div>
                            </div>

                            <div x-show="selectedCircuit === 'merkle'">
                                <div class="text-yellow-400 mb-2">// Merkle 树成员证明</div>
                                <div>树深度: 8 层</div>
                                <div>约束数量: ~240,000</div>
                                <div>变量数量: ~120,000</div>
                                <div class="mt-2">证明叶子节点在 Merkle 树中</div>
                            </div>

                            <div x-show="selectedCircuit === 'custom'">
                                <div class="text-yellow-400 mb-2">// 自定义电路: <span x-text="customCircuit.name || '未命名'"></span></div>
                                <div class="mt-2 text-blue-400">变量定义:</div>
                                <template x-for="(variable, index) in customCircuit.variables" :key="index">
                                    <div class="ml-2 text-sm">
                                        <span :class="variable.type === 'public' ? 'text-green-400' : variable.type === 'private' ? 'text-red-400' : 'text-yellow-400'">
                                            <span x-text="variable.type"></span>
                                        </span>
                                        <span x-text="variable.name"></span>: 
                                        <span class="text-gray-400" x-text="variable.description"></span>
                                    </div>
                                </template>
                                <div class="mt-3 text-cyan-400">R1CS 约束:</div>
                                <template x-for="(constraint, index) in customCircuit.constraints" :key="index">
                                    <div class="ml-2 text-xs">
                                        <span class="text-gray-500">[<span x-text="index + 1"></span>]</span>
                                        (<span x-text="constraint.left || 'A'"></span>) × 
                                        (<span x-text="constraint.right || 'B'"></span>) = 
                                        <span x-text="constraint.output || 'C'"></span>
                                    </div>
                                </template>
                                <div class="mt-3 text-purple-400">电路统计:</div>
                                <div class="ml-2 text-sm">
                                    <div>变量数: <span x-text="customCircuit.variables.length"></span></div>
                                    <div>约束数: <span x-text="customCircuit.constraints.length"></span></div>
                                    <div>公开输入: <span x-text="customCircuit.variables.filter(v => v.type === 'public').length"></span></div>
                                    <div>私密见证: <span x-text="customCircuit.variables.filter(v => v.type === 'private').length"></span></div>
                                </div>
                                <div class="mt-3 text-green-400">
                                    <div x-show="customCircuit.constraints.length > 0">✓ 电路定义完整</div>
                                    <div x-show="customCircuit.constraints.length === 0" class="text-red-400">⚠ 需要添加约束条件</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Circuit Validation -->
                        <div x-show="selectedCircuit === 'custom'" class="mt-4 p-3 rounded-lg"
                             :class="customCircuit.constraints.length > 0 ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'">
                            <div class="flex items-center">
                                <i :class="customCircuit.constraints.length > 0 ? 'fas fa-check-circle text-green-600' : 'fas fa-exclamation-triangle text-yellow-600'" class="mr-2"></i>
                                <span class="text-sm font-medium"
                                      :class="customCircuit.constraints.length > 0 ? 'text-green-800' : 'text-yellow-800'">
                                    <span x-show="customCircuit.constraints.length > 0">电路定义完整，可以运行演示</span>
                                    <span x-show="customCircuit.constraints.length === 0">请至少添加一个约束条件</span>
                                </span>
                            </div>
                            <div x-show="customCircuit.constraints.length > 0" class="mt-2 text-xs text-green-700">
                                将生成包含 <span x-text="customCircuit.constraints.length"></span> 个约束和 
                                <span x-text="customCircuit.variables.length"></span> 个变量的 R1CS 系统
                            </div>
                        </div>

                        <!-- Run Circuit Button -->
                        <button @click="runCircuitDemo()" 
                                :disabled="isCircuitRunning || (selectedCircuit === 'custom' && customCircuit.constraints.length === 0)" 
                                class="w-full mt-4 px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!isCircuitRunning">🚀 运行电路演示</span>
                            <span x-show="isCircuitRunning" class="flex items-center justify-center">
                                <i class="fas fa-spinner fa-spin mr-2"></i>执行中...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Circuit Execution Results -->
        <section class="mb-16" x-show="circuitResults">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">电路执行结果</h2>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Setup Phase -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-3">
                            <i class="fas fa-cogs mr-2"></i>设置阶段
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Universal SRS:</span>
                                <span class="text-green-600" x-text="circuitResults?.setup?.status"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>最大度数:</span>
                                <span x-text="circuitResults?.setup?.maxDegree"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>设置时间:</span>
                                <span x-text="circuitResults?.setup?.time + ' ms'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Proving Phase -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-semibold text-green-800 mb-3">
                            <i class="fas fa-key mr-2"></i>证明阶段
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>证明生成:</span>
                                <span class="text-green-600" x-text="circuitResults?.proving?.status"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>证明大小:</span>
                                <span x-text="circuitResults?.proving?.size + ' bytes'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>证明时间:</span>
                                <span x-text="circuitResults?.proving?.time + ' ms'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Verification Phase -->
                    <div class="rounded-lg p-4" :class="circuitResults?.verification?.isValid !== false ? 'bg-purple-50' : 'bg-red-50'">
                        <h3 class="font-semibold mb-3" :class="circuitResults?.verification?.isValid !== false ? 'text-purple-800' : 'text-red-800'">
                            <i :class="circuitResults?.verification?.isValid !== false ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-2"></i>验证阶段
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>验证结果:</span>
                                <span :class="circuitResults?.verification?.isValid !== false ? 'text-green-600' : 'text-red-600'" 
                                      x-text="circuitResults?.verification?.status"></span>
                            </div>
                            <div x-show="circuitResults?.verification?.failureReason" class="text-red-600 text-xs mt-2 p-2 bg-red-100 rounded">
                                <strong>失败原因:</strong> <span x-text="circuitResults?.verification?.failureReason"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>验证时间:</span>
                                <span x-text="circuitResults?.verification?.time + ' ms'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>安全级别:</span>
                                <span>128-bit</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Execution Log -->
                <div class="mt-6">
                    <h3 class="font-semibold text-gray-800 mb-3">执行日志</h3>
                    <div class="bg-gray-900 text-green-400 font-mono text-sm p-4 rounded-lg h-48 overflow-y-auto">
                        <template x-for="log in executionLogs" :key="log.id">
                            <div :class="getLogColor(log.type)">
                                <span class="text-gray-500" x-text="log.timestamp"></span>
                                <span x-text="log.message"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Demo -->
        <section class="mb-16" x-show="!demoCompleted">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">协议流程演示</h2>
            
            <!-- Step Indicator -->
            <div class="flex justify-center mb-8">
                <div class="flex space-x-4">
                    <template x-for="(step, index) in steps" :key="index">
                        <div class="flex items-center">
                            <div class="flex items-center justify-center w-10 h-10 rounded-full"
                                 :class="currentStep >= index ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-600'">
                                <span x-text="index + 1"></span>
                            </div>
                            <div x-show="index < steps.length - 1" class="w-16 h-0.5 bg-gray-300 mx-2"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Current Step Display -->
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-4xl mx-auto">
                <template x-for="(step, index) in steps" :key="index">
                    <div x-show="currentStep === index" class="text-center">
                        <div class="mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-4"
                                 :class="step.color">
                                <i :class="step.icon + ' text-3xl'"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-4" x-text="step.title"></h3>
                            <p class="text-gray-600 mb-6" x-text="step.description"></p>
                        </div>

                        <!-- Step Content -->
                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">输入</h4>
                                <div class="text-sm text-gray-600" x-html="step.input"></div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">输出</h4>
                                <div class="text-sm text-gray-600" x-html="step.output"></div>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="mb-6">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="protocol-flow h-2 rounded-full transition-all duration-1000"
                                     :style="`width: ${((currentStep + 1) / steps.length) * 100}%`"></div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-between">
                            <button @click="previousStep()" 
                                    :disabled="currentStep === 0"
                                    class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg disabled:opacity-50">
                                上一步
                            </button>
                            <button @click="nextStep()" 
                                    :disabled="currentStep === steps.length - 1"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <span x-text="currentStep === steps.length - 1 ? '完成' : '下一步'"></span>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </section>

        <!-- Technical Details -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">技术细节</h2>
            <div class="grid lg:grid-cols-2 gap-8">
                
                <!-- AHP Components -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-puzzle-piece text-blue-600 mr-2"></i>
                        AHP 组件
                    </h3>
                    <div class="space-y-4">
                        <div class="border-l-4 border-blue-500 pl-4">
                            <h4 class="font-semibold text-gray-800">索引器 (Indexer)</h4>
                            <p class="text-gray-600 text-sm">处理 R1CS 约束系统，生成索引多项式</p>
                            <div class="text-xs text-gray-500 mt-1">
                                多项式: row, col, a_val, b_val, c_val, row_col
                            </div>
                        </div>
                        <div class="border-l-4 border-purple-500 pl-4">
                            <h4 class="font-semibold text-gray-800">证明者 (Prover)</h4>
                            <p class="text-gray-600 text-sm">执行三轮交互协议，生成零知识证明</p>
                            <div class="text-xs text-gray-500 mt-1">
                                多项式: w, z_a, z_b, mask_poly, t, g_1, h_1, g_2, h_2
                            </div>
                        </div>
                        <div class="border-l-4 border-cyan-500 pl-4">
                            <h4 class="font-semibold text-gray-800">验证者 (Verifier)</h4>
                            <p class="text-gray-600 text-sm">验证证明的正确性，支持高效验证</p>
                            <div class="text-xs text-gray-500 mt-1">
                                检查线性组合和多项式承诺
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Structures -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-cube text-purple-600 mr-2"></i>
                        核心数据结构
                    </h3>
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">UniversalSRS</h4>
                            <p class="text-gray-600 text-sm">通用结构化参考字符串，支持多项式承诺</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">IndexVerifierKey</h4>
                            <p class="text-gray-600 text-sm">包含索引信息和承诺的验证密钥</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Proof</h4>
                            <p class="text-gray-600 text-sm">包含承诺、求值和证明者消息的完整证明</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Real-time Performance Monitor -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">实时性能监控</h2>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Performance Metrics -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">性能指标</h3>
                        <div class="space-y-4">
                            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-green-800 font-medium">验证时间复杂度</span>
                                    <span class="text-2xl font-bold text-green-600">O(log n)</span>
                                </div>
                                <div class="w-full bg-green-200 rounded-full h-2">
                                    <div class="bg-green-600 h-2 rounded-full" :style="`width: ${Math.min(100, Math.log2(getCircuitStats().constraints) * 10)}%`"></div>
                                </div>
                                <div class="text-sm text-green-700 mt-1">
                                    当前: ~<span x-text="getCircuitStats().verifyTime"></span> ms
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-blue-800 font-medium">证明大小</span>
                                    <span class="text-2xl font-bold text-blue-600">O(√n)</span>
                                </div>
                                <div class="w-full bg-blue-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" :style="`width: ${Math.min(100, Math.sqrt(getCircuitStats().constraints) / 10)}%`"></div>
                                </div>
                                <div class="text-sm text-blue-700 mt-1">
                                    当前: ~<span x-text="getCircuitStats().proofSize"></span> bytes
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-purple-800 font-medium">证明生成时间</span>
                                    <span class="text-2xl font-bold text-purple-600">O(n)</span>
                                </div>
                                <div class="w-full bg-purple-200 rounded-full h-2">
                                    <div class="bg-purple-600 h-2 rounded-full" :style="`width: ${Math.min(100, getCircuitStats().constraints / 100)}%`"></div>
                                </div>
                                <div class="text-sm text-purple-700 mt-1">
                                    预估: ~<span x-text="Math.floor(getCircuitStats().constraints / 50)"></span> 秒
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Circuit Analysis -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">实时电路分析</h3>
                        <div class="bg-gray-900 rounded-lg p-4 text-green-400 font-mono text-sm h-64 overflow-y-auto">
                            <div class="text-yellow-400 mb-2">// 实时电路分析报告</div>
                            <div>电路类型: <span x-text="selectedCircuit"></span></div>
                            <div>约束数量: <span x-text="getCircuitStats().constraints"></span></div>
                            <div>变量数量: <span x-text="getCircuitStats().variables"></span></div>
                            <div class="mt-2 text-cyan-400">性能分析:</div>
                            <div class="ml-2">
                                <div>• Setup 阶段: ~<span x-text="Math.floor(getCircuitStats().constraints / 10)"></span> ms</div>
                                <div>• Index 阶段: ~<span x-text="Math.floor(getCircuitStats().constraints / 5)"></span> ms</div>
                                <div>• Prove 阶段: ~<span x-text="Math.floor(getCircuitStats().constraints / 2)"></span> ms</div>
                                <div>• Verify 阶段: ~<span x-text="getCircuitStats().verifyTime"></span> ms</div>
                            </div>
                            <div class="mt-2 text-blue-400">资源需求:</div>
                            <div class="ml-2">
                                <div>• 内存: ~<span x-text="Math.floor((getCircuitStats().constraints + getCircuitStats().variables) / 1000)"></span> MB</div>
                                <div>• 存储: ~<span x-text="getCircuitStats().proofSize"></span> bytes</div>
                                <div>• CPU: 单核心</div>
                            </div>
                            <template x-if="circuitResults">
                                <div class="mt-2 text-green-400">
                                    <div>✓ 最近执行成功</div>
                                    <div>验证结果: 通过</div>
                                    <div>安全级别: 128-bit</div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Interactive Performance Chart -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">性能对比图表</h3>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-3xl font-bold text-blue-600 mb-2">
                                <span x-text="Math.floor(getCircuitStats().constraints / 1000)"></span>K
                            </div>
                            <div class="text-gray-600">约束规模</div>
                            <div class="mt-2 text-xs text-gray-500">
                                复杂度: <span x-text="getCircuitStats().constraints < 1000 ? '简单' : getCircuitStats().constraints < 10000 ? '中等' : '复杂'"></span>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-3xl font-bold text-green-600 mb-2">
                                <span x-text="getCircuitStats().verifyTime"></span>ms
                            </div>
                            <div class="text-gray-600">验证时间</div>
                            <div class="mt-2 text-xs text-gray-500">
                                效率: <span x-text="getCircuitStats().verifyTime < 50 ? '优秀' : getCircuitStats().verifyTime < 200 ? '良好' : '一般'"></span>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-3xl font-bold text-purple-600 mb-2">
                                <span x-text="Math.floor(getCircuitStats().proofSize / 1024)"></span>KB
                            </div>
                            <div class="text-gray-600">证明大小</div>
                            <div class="mt-2 text-xs text-gray-500">
                                紧凑性: <span x-text="getCircuitStats().proofSize < 2048 ? '优秀' : getCircuitStats().proofSize < 8192 ? '良好' : '一般'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Code Structure -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">代码结构</h2>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">
                            <i class="fas fa-folder text-yellow-600 mr-2"></i>
                            核心模块
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <i class="fas fa-file-code text-blue-600 mr-3"></i>
                                <div>
                                    <div class="font-semibold">lib.rs</div>
                                    <div class="text-sm text-gray-600">主要的 Marlin 协议实现</div>
                                </div>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <i class="fas fa-file-code text-purple-600 mr-3"></i>
                                <div>
                                    <div class="font-semibold">ahp/</div>
                                    <div class="text-sm text-gray-600">代数全息证明模块</div>
                                </div>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <i class="fas fa-file-code text-green-600 mr-3"></i>
                                <div>
                                    <div class="font-semibold">data_structures.rs</div>
                                    <div class="text-sm text-gray-600">核心数据结构定义</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">
                            <i class="fas fa-cogs text-cyan-600 mr-2"></i>
                            依赖库
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <i class="fas fa-cube text-red-600 mr-3"></i>
                                <div>
                                    <div class="font-semibold">ark-poly-commit</div>
                                    <div class="text-sm text-gray-600">多项式承诺方案</div>
                                </div>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <i class="fas fa-cube text-orange-600 mr-3"></i>
                                <div>
                                    <div class="font-semibold">ark-relations</div>
                                    <div class="text-sm text-gray-600">R1CS 约束系统</div>
                                </div>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <i class="fas fa-cube text-indigo-600 mr-3"></i>
                                <div>
                                    <div class="font-semibold">ark-ff</div>
                                    <div class="text-sm text-gray-600">有限域运算</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-4">基于 Arkworks 生态系统构建的 Marlin zkSNARK 实现</p>
            <div class="flex justify-center space-x-6">
                <a href="https://github.com/arkworks-rs/marlin" class="text-gray-400 hover:text-white">
                    <i class="fab fa-github text-xl"></i>
                </a>
                <a href="https://eprint.iacr.org/2019/1047" class="text-gray-400 hover:text-white">
                    <i class="fas fa-file-alt text-xl"></i>
                </a>
            </div>
        </div>
    </footer>

    <script>
        function marlinDemo() {
            return {
                currentStep: 0,
                demoCompleted: false,
                // Initialize the real Marlin simulator
                simulator: new MarlinSimulator(),
                // Circuit Builder Properties
                selectedCircuit: 'multiplication',
                circuitParams: {
                    a: 3,
                    b: 5,
                    sideA: 3,
                    sideB: 4
                },
                customConstraints: 100,
                customVariables: 50,
                customCircuit: {
                    name: '',
                    variables: [],
                    constraints: []
                },
                isCircuitRunning: false,
                circuitResults: null,
                executionLogs: [],
                
                steps: [
                    {
                        title: "通用设置阶段",
                        description: "生成支持任意电路的通用结构化参考字符串 (Universal SRS)",
                        icon: "fas fa-cogs text-white",
                        color: "bg-blue-500",
                        input: `
                            <div class="font-mono text-xs">
                                <div>• num_constraints: 约束数量</div>
                                <div>• num_variables: 变量数量</div>
                                <div>• num_non_zero: 非零元素数量</div>
                                <div>• rng: 随机数生成器</div>
                            </div>
                        `,
                        output: `
                            <div class="font-mono text-xs">
                                <div>• UniversalSRS&lt;F, PC&gt;</div>
                                <div>• 多项式承诺方案参数</div>
                                <div>• 支持最大度数: max_degree</div>
                            </div>
                        `
                    },
                    {
                        title: "电路索引阶段",
                        description: "将约束系统转换为多项式表示，生成索引密钥对",
                        icon: "fas fa-database text-white",
                        color: "bg-purple-500",
                        input: `
                            <div class="font-mono text-xs">
                                <div>• UniversalSRS</div>
                                <div>• ConstraintSynthesizer</div>
                                <div>• R1CS 约束系统</div>
                            </div>
                        `,
                        output: `
                            <div class="font-mono text-xs">
                                <div>• IndexProverKey</div>
                                <div>• IndexVerifierKey</div>
                                <div>• 索引多项式承诺</div>
                            </div>
                        `
                    },
                    {
                        title: "证明生成阶段",
                        description: "证明者执行三轮 AHP 协议，生成零知识证明",
                        icon: "fas fa-key text-white",
                        color: "bg-green-500",
                        input: `
                            <div class="font-mono text-xs">
                                <div>• IndexProverKey</div>
                                <div>• 私有见证 (witness)</div>
                                <div>• 公开输入</div>
                                <div>• 随机性</div>
                            </div>
                        `,
                        output: `
                            <div class="font-mono text-xs">
                                <div>• Proof&lt;F, PC&gt;</div>
                                <div>• 多项式承诺</div>
                                <div>• 求值结果</div>
                                <div>• PC 证明</div>
                            </div>
                        `
                    },
                    {
                        title: "证明验证阶段",
                        description: "验证者高效验证证明的正确性，无需重新计算",
                        icon: "fas fa-check-circle text-white",
                        color: "bg-cyan-500",
                        input: `
                            <div class="font-mono text-xs">
                                <div>• IndexVerifierKey</div>
                                <div>• 公开输入</div>
                                <div>• Proof</div>
                                <div>• 随机性</div>
                            </div>
                        `,
                        output: `
                            <div class="font-mono text-xs">
                                <div>• bool: 验证结果</div>
                                <div>• O(log n) 验证时间</div>
                                <div>• 安全性保证</div>
                            </div>
                        `
                    }
                ],
                
                nextStep() {
                    if (this.currentStep < this.steps.length - 1) {
                        this.currentStep++;
                    } else {
                        this.demoCompleted = true;
                    }
                },
                
                previousStep() {
                    if (this.currentStep > 0) {
                        this.currentStep--;
                    }
                },

                // Circuit Builder Methods
                updateCircuitParams() {
                    // Reset parameters when circuit type changes
                    if (this.selectedCircuit === 'multiplication') {
                        this.circuitParams = { a: 3, b: 5 };
                    } else if (this.selectedCircuit === 'quadratic') {
                        this.circuitParams = { sideA: 3, sideB: 4 };
                    }
                },

                getCircuitStats() {
                    let constraints, variables, proofSize, verifyTime;
                    
                    switch (this.selectedCircuit) {
                        case 'multiplication':
                            constraints = 2;
                            variables = 4;
                            break;
                        case 'quadratic':
                            constraints = 4;
                            variables = 7;
                            break;
                        case 'hash':
                            constraints = 30000;
                            variables = 15000;
                            break;
                        case 'merkle':
                            constraints = 240000;
                            variables = 120000;
                            break;
                        case 'custom':
                            constraints = this.customCircuit.constraints.length || 1;
                            variables = this.customCircuit.variables.length || 1;
                            break;
                        default:
                            constraints = 100;
                            variables = 50;
                    }
                    
                    proofSize = Math.floor(1024 + Math.sqrt(constraints) * 32);
                    verifyTime = Math.floor(Math.log2(constraints) * 5 + 10);
                    
                    return {
                        constraints,
                        variables,
                        proofSize,
                        verifyTime
                    };
                },

                async runCircuitDemo() {
                    if (this.isCircuitRunning) return;
                    
                    this.isCircuitRunning = true;
                    this.circuitResults = null;
                    this.executionLogs = [];
                    
                    // Debug info
                    console.log('🔍 Debug: simulator object:', this.simulator);
                    console.log('🔍 Debug: selected circuit:', this.selectedCircuit);
                    console.log('🔍 Debug: circuit params:', this.circuitParams);
                    
                    try {
                        const stats = this.getCircuitStats();
                        
                        // Setup Phase
                        this.addLog('info', '开始通用设置阶段...');
                        await this.delay(500);
                        
                        const setupTime = Math.floor(stats.constraints / 10 + Math.random() * 100);
                        this.addLog('success', `Universal SRS 生成完成 (${setupTime}ms)`);
                        
                        // Indexing Phase
                        this.addLog('info', '开始电路索引阶段...');
                        await this.delay(800);
                        
                        const indexTime = Math.floor(stats.constraints / 5 + Math.random() * 200);
                        this.addLog('success', `电路索引完成 (${indexTime}ms)`);
                        
                        // Proving Phase
                        this.addLog('info', '开始证明生成阶段...');
                        await this.delay(1200);
                        
                        const provingTime = Math.floor(stats.constraints / 2 + Math.random() * 500);
                        const proofSize = stats.proofSize;
                        this.addLog('success', `零知识证明生成完成 (${provingTime}ms, ${proofSize} bytes)`);
                        
                        // Verification Phase
                        this.addLog('info', '开始证明验证阶段...');
                        await this.delay(300);
                        
                        // 准备验证数据
                        const circuitData = this.selectedCircuit === 'custom' ? this.customCircuit : null;
                        const witnessData = this.getWitnessForCircuit();
                        const publicData = this.getPublicInputForCircuit();
                        
                        // 实际进行约束验证
                        const verificationResult = await this.simulator.simulateCircuitVerification(
                            witnessData, 
                            publicData, 
                            this.selectedCircuit,
                            circuitData
                        );
                        
                        const verifyTime = verificationResult.verificationTime;
                        
                        if (verificationResult.isValid) {
                            this.addLog('success', `证明验证成功 (${verifyTime}ms)`);
                        } else {
                            this.addLog('error', `证明验证失败: ${verificationResult.failureReason}`);
                        }
                        
                        // 显示详细的检查结果
                        verificationResult.checksPerformed.forEach(check => {
                            if (check.includes('❌')) {
                                this.addLog('error', check);
                            } else if (check.includes('✅')) {
                                this.addLog('success', check);
                            } else {
                                this.addLog('info', check);
                            }
                        });
                        
                        // Set results
                        this.circuitResults = {
                            setup: {
                                status: '✓ 完成',
                                maxDegree: stats.constraints * 2,
                                time: setupTime
                            },
                            proving: {
                                status: '✓ 完成',
                                size: proofSize,
                                time: provingTime
                            },
                            verification: {
                                status: verificationResult.isValid ? '✓ 验证通过' : '✗ 验证失败',
                                time: verifyTime,
                                isValid: verificationResult.isValid,
                                failureReason: verificationResult.failureReason
                            }
                        };
                        
                        if (verificationResult.isValid) {
                            this.addLog('success', '🎉 电路演示完成！零知识证明成功验证。');
                        } else {
                            this.addLog('error', '❌ 电路演示失败！约束验证不通过。');
                        }
                        
                    } catch (error) {
                        this.addLog('error', `演示出错: ${error.message}`);
                    } finally {
                        this.isCircuitRunning = false;
                    }
                },

                addLog(type, message) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.executionLogs.push({
                        id: Date.now() + Math.random(),
                        type,
                        message,
                        timestamp
                    });
                    
                    // Auto scroll to bottom
                    this.$nextTick(() => {
                        const logContainer = document.querySelector('.bg-gray-900');
                        if (logContainer) {
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    });
                },

                getLogColor(type) {
                    switch (type) {
                        case 'success':
                            return 'text-green-400';
                        case 'error':
                            return 'text-red-400';
                        case 'warning':
                            return 'text-yellow-400';
                        case 'info':
                        default:
                            return 'text-cyan-400';
                    }
                },

                delay(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                },

                // Custom Circuit Builder Methods
                addVariable() {
                    this.customCircuit.variables.push({
                        type: 'private',
                        name: `x${this.customCircuit.variables.length + 1}`,
                        description: ''
                    });
                },

                removeVariable(index) {
                    this.customCircuit.variables.splice(index, 1);
                },

                addConstraint() {
                    this.customCircuit.constraints.push({
                        left: '',
                        right: '',
                        output: ''
                    });
                },

                removeConstraint(index) {
                    this.customCircuit.constraints.splice(index, 1);
                },

                loadTemplate(templateType) {
                    switch (templateType) {
                        case 'polynomial':
                            this.customCircuit = {
                                name: '多项式验证电路',
                                variables: [
                                    { type: 'private', name: 'x', description: '多项式输入' },
                                    { type: 'private', name: 'x_squared', description: 'x的平方' },
                                    { type: 'private', name: 'x_cubed', description: 'x的立方' },
                                    { type: 'public', name: 'result', description: '多项式结果' }
                                ],
                                constraints: [
                                    { left: 'x', right: 'x', output: 'x_squared' },
                                    { left: 'x_squared', right: 'x', output: 'x_cubed' },
                                    { left: '2*x_cubed + 3*x_squared + x', right: '1', output: 'result' }
                                ]
                            };
                            break;
                        case 'comparison':
                            this.customCircuit = {
                                name: '数值比较电路',
                                variables: [
                                    { type: 'private', name: 'a', description: '私密数值A' },
                                    { type: 'private', name: 'b', description: '私密数值B' },
                                    { type: 'private', name: 'diff', description: '差值' },
                                    { type: 'public', name: 'is_greater', description: 'A是否大于B' }
                                ],
                                constraints: [
                                    { left: 'a', right: '1', output: 'a' },
                                    { left: 'b', right: '1', output: 'b' },
                                    { left: 'a - b', right: '1', output: 'diff' },
                                    { left: 'diff * inv_diff', right: '1', output: 'is_greater' }
                                ]
                            };
                            break;
                        case 'range':
                            this.customCircuit = {
                                name: '范围证明电路',
                                variables: [
                                    { type: 'private', name: 'value', description: '被证明的值' },
                                    { type: 'private', name: 'r1', description: '范围检查变量1' },
                                    { type: 'private', name: 'r2', description: '范围检查变量2' },
                                    { type: 'public', name: 'min_val', description: '最小值' },
                                    { type: 'public', name: 'max_val', description: '最大值' }
                                ],
                                constraints: [
                                    { left: 'value - min_val', right: '1', output: 'r1' },
                                    { left: 'max_val - value', right: '1', output: 'r2' },
                                    { left: 'r1', right: 'r1_inv', output: '1' },
                                    { left: 'r2', right: 'r2_inv', output: '1' }
                                ]
                            };
                            break;
                        case 'sudoku':
                            this.customCircuit = {
                                name: '数独验证电路',
                                variables: [
                                    { type: 'private', name: 'grid[0..80]', description: '9x9数独网格' },
                                    { type: 'public', name: 'known_cells', description: '已知格子的值' },
                                    { type: 'private', name: 'row_sums[0..8]', description: '行和验证' },
                                    { type: 'private', name: 'col_sums[0..8]', description: '列和验证' },
                                    { type: 'private', name: 'box_sums[0..8]', description: '宫和验证' }
                                ],
                                constraints: [
                                    { left: 'grid[i]', right: 'grid[i] - 1', output: 'range_check_1[i]' },
                                    { left: 'grid[i] - 9', right: '1', output: 'range_check_2[i]' },
                                    { left: 'row_sum[i]', right: '1', output: '45' },
                                    { left: 'col_sum[i]', right: '1', output: '45' },
                                    { left: 'box_sum[i]', right: '1', output: '45' }
                                ]
                            };
                            break;
                        case 'error_contradiction':
                            this.customCircuit = {
                                name: '矛盾约束测试电路',
                                variables: [
                                    { type: 'private', name: 'x', description: '任意私密值' },
                                    { type: 'public', name: 'result', description: '预期结果' }
                                ],
                                constraints: [
                                    { left: '1', right: '1', output: '0' },  // 明显错误：1 × 1 ≠ 0
                                    { left: 'x', right: '1', output: 'x' }   // 这个是正确的
                                ]
                            };
                            break;
                        case 'error_zero_mult':
                            this.customCircuit = {
                                name: '零乘法错误测试电路',
                                variables: [
                                    { type: 'private', name: 'x', description: '任意私密值' },
                                    { type: 'public', name: 'result', description: '错误的结果' }
                                ],
                                constraints: [
                                    { left: '0', right: 'x', output: '5' },  // 错误：0 × x ≠ 5
                                    { left: 'x', right: '0', output: '3' }   // 错误：x × 0 ≠ 3
                                ]
                            };
                            break;
                    }
                },

                getCustomCircuitDescription() {
                    if (!this.customCircuit.name) return "未定义的自定义电路";
                    
                    const publicVars = this.customCircuit.variables.filter(v => v.type === 'public').length;
                    const privateVars = this.customCircuit.variables.filter(v => v.type === 'private').length;
                    const constraints = this.customCircuit.constraints.length;
                    
                    return `${this.customCircuit.name} (${constraints}个约束, ${publicVars}个公开变量, ${privateVars}个私密变量)`;
                },

                // 获取当前电路的见证数据
                getWitnessForCircuit() {
                    switch (this.selectedCircuit) {
                        case 'multiplication':
                            return { a: this.circuitParams.a, b: this.circuitParams.b };
                        case 'quadratic':
                            return { sideA: this.circuitParams.sideA, sideB: this.circuitParams.sideB };
                        case 'hash':
                            return { preimage: 'demo_preimage' };
                        case 'merkle':
                            return { leaf: 'demo_leaf', path: ['demo_path'] };
                        case 'custom':
                            // 为自定义电路生成示例见证数据
                            const witness = {};
                            this.customCircuit.variables.forEach(variable => {
                                if (variable.type === 'private') {
                                    witness[variable.name] = Math.floor(Math.random() * 10) + 1;
                                }
                            });
                            return witness;
                        default:
                            return {};
                    }
                },

                // 获取当前电路的公开输入
                getPublicInputForCircuit() {
                    switch (this.selectedCircuit) {
                        case 'multiplication':
                            return { c: this.circuitParams.a * this.circuitParams.b };
                        case 'quadratic':
                            const c = Math.sqrt(this.circuitParams.sideA ** 2 + this.circuitParams.sideB ** 2);
                            return { c: c };
                        case 'hash':
                            return { hash: 'demo_hash_output' };
                        case 'merkle':
                            return { root: 'demo_merkle_root' };
                        case 'custom':
                            // 为自定义电路生成示例公开输入
                            const publicInput = {};
                            this.customCircuit.variables.forEach(variable => {
                                if (variable.type === 'public') {
                                    publicInput[variable.name] = Math.floor(Math.random() * 10) + 1;
                                }
                            });
                            return publicInput;
                        default:
                            return {};
                    }
                }
            }
        }
    </script>
</body>
</html>